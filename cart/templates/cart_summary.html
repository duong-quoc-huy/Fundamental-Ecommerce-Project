{% extends 'base.html' %}
{% load static %}

{% block title %}Your Cart{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content%}
<!-- Header-->
<header class="bg-dark py-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">Shopping Cart</h1>
            <p class="lead fw-normal text-white-50 mb-0">Review your items before checkout</p>
        </div>
    </div>
</header>

<!-- Section-->
<div class="container my-5">
    <div class="row">
        <!-- Cart Items Column -->
        <div class="col-lg-8">
            {% for product in cart_products %}
            <div class="card mb-3 shadow-sm border-0" data-product-id="{{ product.id }}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Product Image -->
                        <div class="col-md-3 col-sm-4 text-center">
                            {% with first_variant=product.variants.first %}
                                {% if first_variant and first_variant.images.first %}
                                    <img src="{{ first_variant.images.first.image.url }}" 
                                         alt="{{ product.name }}" 
                                         class="cart-item-image">
                                {% else %}
                                    <img src="{% static 'assets/no_image.png' %}" 
                                         alt="No image"
                                         class="cart-item-image">
                                {% endif %}
                            {% endwith %}
                        </div>
                        
                        <!-- Product Details -->
                        <div class="col-md-5 col-sm-8">
                            <h5 class="card-title mb-2">{{ product.name }}</h5>
                            <p class="text-muted small mb-2">{{ product.category|default:"Uncategorized" }}</p>
                            
                            {% if product.variants.first %}
                            <p class="text-muted small mb-2">
                                <strong>Variant:</strong> {{ product.variants.first.name }}
                            </p>
                            {% endif %}
                            
                            <!-- Stock Status -->
                            <p class="mb-2">
                                {% if product.stock > 0 %}
                                    <span class="badge bg-success">In Stock</span>
                                {% else %}
                                    <span class="badge bg-danger">Out of Stock</span>
                                {% endif %}
                            </p>
                            
                            <!-- Action Links -->
                            <div class="mt-3">
                                <a href="#" class="text-primary text-decoration-none small me-3">
                                    <i class="bi bi-heart"></i> Save for later
                                </a>
                                <a href="#" class="text-danger text-decoration-none small remove-item" data-product-id="{{ product.id }}">
                                    <i class="bi bi-trash"></i> Remove
                                </a>
                            </div>
                        </div>
                        
                        <!-- Quantity & Price -->
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <!-- Price -->
                            <h5 class="mb-3">
                                {% if product.sale_price %}
                                    <span class="text-danger fw-bold item-price" data-price="{{ product.sale_price }}">${{ product.sale_price }}</span>
                                    <br>
                                    <small class="text-muted text-decoration-line-through">${{ product.price }}</small>
                                {% else %}
                                    <span class="fw-bold item-price" data-price="{{ product.price }}">${{ product.price }}</span>
                                {% endif %}
                            </h5>
                            
                            <!-- Quantity Selector -->
                            <div class="d-flex justify-content-md-end justify-content-center align-items-center mb-3">
                                <label class="me-2 small">Quantity:</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-decrease" data-product-id="{{ product.id }}">-</button>
                                    <input type="number" class="form-control form-control-sm text-center quantity-input" value="{{ product.cart_quantity|default:1 }}" min="1" max="{{ product.stock }}" data-product-id="{{ product.id }}" data-max="{{ product.stock }}" style="max-width: 50px;" readonly>
                                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-increase" data-product-id="{{ product.id }}" data-max="{{ product.stock }}">+</button>
                                </div>
                            </div>
                            
                            <!-- Subtotal -->
                            <p class="text-muted small mb-0">
                                Subtotal: <strong class="item-subtotal">${{ product.subtotal|default:product.price }}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-5">
                    <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3">Your cart is empty</h4>
                    <p class="text-muted">Add items to get started</p>
                    <a href="{% url 'home' %}" class="btn btn-primary mt-3">Continue Shopping</a>
                </div>
            </div>
            {% endfor %}
            
            <!-- Continue Shopping Button -->
            {% if cart_products %}
            <div class="mt-3">
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Continue Shopping
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Order Summary Column -->
        <div class="col-lg-4">
            <div class="order-summary-wrapper">
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Order Summary</h5>
                        
                        <!-- Pricing Details -->
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Subtotal</span>
                            <span id="summary-subtotal">${{ subtotal|default:"0.00" }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Shipping</span>
                            <span class="text-success">FREE</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Tax</span>
                            <span id="summary-tax">${{ tax|default:"0.00" }}</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="mb-0">Total</h5>
                            <h5 class="mb-0 text-primary" id="summary-total">${{ total|default:"0.00" }}</h5>
                        </div>
                        
                        <!-- Checkout Button -->
                        <a href="{% url 'payment:checkout_shipping' %}" class="btn btn-primary w-100 btn-lg">
                            Proceed to Checkout
                        </a>
                        
                        <!-- Security Badge -->
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i> Secure Checkout
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Benefits Section -->
            <div class="card shadow-sm border-0 mt-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-truck" style="font-size: 1.5rem; color: #0d6efd;"></i>
                        <div class="ms-3">
                            <strong>Free Shipping</strong>
                            <p class="text-muted small mb-0">On orders over $50</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-arrow-clockwise" style="font-size: 1.5rem; color: #0d6efd;"></i>
                        <div class="ms-3">
                            <strong>Easy Returns</strong>
                            <p class="text-muted small mb-0">30-day return policy</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-shield-check" style="font-size: 1.5rem; color: #0d6efd;"></i>
                        <div class="ms-3">
                            <strong>Secure Payment</strong>
                            <p class="text-muted small mb-0">100% secure transactions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Function to update item subtotal and order summary
    function updateCartDisplay(productId, newQuantity, itemPrice) {
        // Update item subtotal
        var itemSubtotal = (parseFloat(itemPrice) * newQuantity).toFixed(2);
        $('[data-product-id="' + productId + '"]').find('.item-subtotal').text('$' + itemSubtotal);
        
        // Recalculate order summary
        var totalSubtotal = 0;
        $('.quantity-input').each(function() {
            var qty = parseInt($(this).val());
            var price = parseFloat($(this).closest('.col-md-4').find('.item-price').data('price'));
            totalSubtotal += (qty * price);
        });
        
        var tax = (totalSubtotal * 0.1).toFixed(2);
        var total = (totalSubtotal + parseFloat(tax)).toFixed(2);
        
        // Update order summary display
        $('#summary-subtotal').text('$' + totalSubtotal.toFixed(2));
        $('#summary-tax').text('$' + tax);
        $('#summary-total').text('$' + total);
    }
    
    // Quantity increase button
    $('.quantity-increase').click(function() {
        var productId = $(this).data('product-id');
        var maxStock = $(this).data('max');
        var quantityInput = $('input[data-product-id="' + productId + '"]');
        var currentQty = parseInt(quantityInput.val());
        
        if (currentQty < maxStock) {
            var newQty = currentQty + 1;
            quantityInput.val(newQty);
            
            // Get item price
            var itemPrice = $(this).closest('.col-md-4').find('.item-price').data('price');
            
            // Update display immediately
            updateCartDisplay(productId, newQty, itemPrice);
            
            // Send AJAX request to update backend
            $.ajax({
                type: 'POST',
                url: "{% url 'cart_update' %}",
                data: {
                    product_id: productId,
                    quantity: newQty,
                    action: 'post',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (!response.success) {
                        alert('Failed to update quantity.');
                        location.reload(); 
                    }
                },
                error: function() {
                    alert('An error occurred while updating quantity.');
                    location.reload();
                }
            });
        } else {
            alert('Maximum stock reached!');
        }
    });
    
    // Quantity decrease button
    $('.quantity-decrease').click(function() {
        var productId = $(this).data('product-id');
        var quantityInput = $('input[data-product-id="' + productId + '"]');
        var currentQty = parseInt(quantityInput.val());
        
        if (currentQty > 1) {
            var newQty = currentQty - 1;
            quantityInput.val(newQty);
            
            // Get item price
            var itemPrice = $(this).closest('.col-md-4').find('.item-price').data('price');
            
            // Update display immediately
            updateCartDisplay(productId, newQty, itemPrice);
            
            // Send AJAX request to update backend
            $.ajax({
                type: 'POST',
                url: "{% url 'cart_update' %}",
                data: {
                    product_id: productId,
                    quantity: newQty,
                    action: 'post',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (!response.success) {
                        alert('Failed to update quantity.');
                        location.reload();
                    }
                },
                error: function() {
                    alert('An error occurred while updating quantity.');
                    location.reload();
                }
            });
        }
    });
    
    // Remove item from cart
    $('.remove-item').click(function(e) {
        e.preventDefault();
        var productId = $(this).data('product-id');
        var cartItem = $(this).closest('.card');

        $.ajax({
            type: 'POST',
            url: "{% url 'cart_delete' %}",
            data: {
                product_id: productId,
                action: 'post',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    cartItem.remove(); 
                    if (response.cart_quantity === 0) {
                        // Show empty cart message
                        $('.col-lg-8').html(`
                            <div class="card shadow-sm border-0">
                                <div class="card-body text-center py-5">
                                    <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
                                    <h4 class="mt-3">Your cart is empty</h4>
                                    <p class="text-muted">Add items to get started</p>
                                    <a href="{% url 'home' %}" class="btn btn-primary mt-3">Continue Shopping</a>
                                </div>
                            </div>
                        `);
                    }
                    // Update order summary
                    $('#summary-subtotal').text('$' + response.subtotal);
                    $('#summary-tax').text('$' + response.tax);
                    $('#summary-total').text('$' + response.total);
                } else {
                    alert('Failed to remove item from cart.');
                }
            },
            error: function() {
                alert('An error occurred while removing the item.');
            }
        });
    });
});
</script>
{% endblock %}